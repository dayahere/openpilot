# GitHub Actions - Complete Build Workflow
# Builds: Windows Installer, Linux Packages, Android APK, VSCode Extension, Web App

name: Complete Production Build

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-linux-packages:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install desktop dependencies
        working-directory: ./desktop
        run: npm ci
      - name: Build React app
        working-directory: ./desktop
        run: npm run build
      - name: Build Linux packages
        working-directory: ./desktop
        run: npm run build:linux
      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: desktop/dist/*.AppImage
          retention-days: 30
      - name: Upload Linux .deb
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: desktop/dist/*.deb
          retention-days: 30
  # ======================
  # DESKTOP: WINDOWS
  # ======================
  build-windows-installer:
    runs-on: windows-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install workspace dependencies
        run: npm ci --workspaces
      - name: Install desktop dependencies
        working-directory: ./desktop
        run: npm ci
      - name: Build React app
        working-directory: ./desktop
        run: npm run build
      - name: Build Windows installer
        working-directory: ./desktop
        run: npm run build:win
      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: desktop/dist/*.exe
          retention-days: 30

  build-vscode-extension:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install core dependencies
        working-directory: ./core
        run: npm ci
      - name: Build core library
        working-directory: ./core
        run: npm run build
      - name: Pack core as tarball
        working-directory: ./core
        id: pack_core
        run: |
          npm pack --silent
          TARBALL=$(ls *.tgz | head -1)
          echo "TARBALL=$TARBALL" >> $GITHUB_ENV
          echo "::set-output name=tarball::$TARBALL"
          echo "Tarball size: $(ls -l $TARBALL | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          sha512sum $TARBALL > tarball.sha512
          echo "Tarball SHA512: $(cat tarball.sha512)" >> $GITHUB_STEP_SUMMARY
      - name: Copy core tarball into extension
        run: cp core/${{ steps.pack_core.outputs.tarball }} vscode-extension/
      - name: Install VSCode extension dev dependencies
        working-directory: ./vscode-extension
        run: |
          rm -f package-lock.json || true
          rm -rf node_modules || true
          npm ci --omit=prod
      - name: Compile VSCode extension
        working-directory: ./vscode-extension
        run: npm run compile
      - name: Install VSCode extension production dependencies
        working-directory: ./vscode-extension
        run: |
          rm -rf node_modules || true
          npm install --production file:./${{ steps.pack_core.outputs.tarball }}
          npm install --production
      - name: Package VSCode extension
        working-directory: ./vscode-extension
        run: |
          npm install -g @vscode/vsce
          vsce package --no-dependencies --allow-missing-repository
      - name: Upload VSCode extension
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension
          path: vscode-extension/*.vsix
          retention-days: 30
  
  # ======================
  # ANDROID APK
  # ======================
  build-android-apk:
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      - name: Install workspace dependencies
        run: npm ci --workspaces

      - name: Install web dependencies
        working-directory: ./web
        run: npm ci

      - name: Install core dependencies
        working-directory: ./core
        run: npm ci

      - name: Build core library
        working-directory: ./core
        run: npm run build

      - name: Pack core as tarball
        working-directory: ./core
        run: |
          npm pack --silent
          TARBALL=$(ls *.tgz | head -1)
          echo "TARBALL=$TARBALL" >> $GITHUB_ENV
          echo "Tarball size: $(ls -l $TARBALL | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          sha512sum $TARBALL > tarball.sha512
          echo "Tarball SHA512: $(cat tarball.sha512)" >> $GITHUB_STEP_SUMMARY

      - name: Copy core tarball into extension
        run: cp core/${{ steps.pack_core.outputs.tarball }} vscode-extension/

      - name: Install VSCode extension dev dependencies
        working-directory: ./vscode-extension
        run: |
          rm -f package-lock.json || true
          rm -rf node_modules || true
          npm ci --omit=prod

      - name: Compile VSCode extension
        working-directory: ./vscode-extension
        run: npm run compile

      - name: Install VSCode extension production dependencies
        working-directory: ./vscode-extension
        run: |
          rm -rf node_modules || true
          npm install --production file:./${{ steps.pack_core.outputs.tarball }}
          npm install --production

      - name: Package VSCode extension
        working-directory: ./vscode-extension
        run: |
          npm install -g @vscode/vsce
          vsce package --no-dependencies --allow-missing-repository
      - name: Install workspace dependencies
        run: npm ci --workspaces

      - name: Pack core as tarball
        working-directory: ./core
        run: |
          npm pack --silent
          echo "TARBALL=openpilot-core-1.0.0.tgz" >> $GITHUB_ENV
          echo "Tarball size: $(ls -l $TARBALL | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          sha512sum $TARBALL > tarball.sha512
          echo "Tarball SHA512: $(cat tarball.sha512)" >> $GITHUB_STEP_SUMMARY

      - name: Copy core tarball into extension
        run: cp core/${{ env.TARBALL }} vscode-extension/
      
      - name: Install VSCode extension dev dependencies
        working-directory: ./vscode-extension
        run: |
          rm -f package-lock.json || true
          rm -rf node_modules || true
          npm install --omit=prod --legacy-peer-deps
          npm audit fix --legacy-peer-deps

      - name: Compile VSCode extension
        working-directory: ./vscode-extension
        run: npm run compile

      - name: Install VSCode extension production dependencies
        working-directory: ./vscode-extension
        run: |
          rm -rf node_modules || true
          npm install --production --legacy-peer-deps file:./${{ env.TARBALL }}
          npm install --production --legacy-peer-deps
          npm audit fix --legacy-peer-deps
      
      - name: Package VSCode extension
        working-directory: ./vscode-extension
        run: |
          npm install -g @vscode/vsce
          vsce package --no-dependencies --allow-missing-repository
      
      - name: Upload VSCode extension
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension
          path: vscode-extension/*.vsix
          retention-days: 30
  
  # ======================
  # WEB APP
  # ======================
  build-web-app:
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install workspace dependencies
        run: npm install --workspaces --legacy-peer-deps
      
      - name: Install web dependencies
        working-directory: ./web
        run: |
          npm install --legacy-peer-deps
          npm audit fix --legacy-peer-deps
      
      - name: Build web app
        working-directory: ./web
        run: npm run build
      
      - name: Create web app archive
        working-directory: ./web
        run: |
          cd build
          zip -r ../openpilot-web-${{ github.ref_name }}.zip .
      
      - name: Upload web app
        uses: actions/upload-artifact@v4
        with:
          name: web-app
          path: web/openpilot-web-*.zip
          retention-days: 30
  
  # ======================
  # TESTS WITH COVERAGE
  # ======================
  test-with-coverage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install workspace dependencies
        run: npm ci --workspaces

      - name: Install core dependencies
        working-directory: ./core
        run: npm ci

      - name: Install test dependencies
        working-directory: ./tests
        run: npm ci
      
      - name: Run tests with coverage
        working-directory: ./tests
        run: npm test -- --coverage --collectCoverageFrom='../core/src/**/*.ts'
        continue-on-error: true  # Continue even if tests fail
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: tests/coverage/
          retention-days: 30
      
      - name: Display coverage summary
        working-directory: ./tests
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          cat coverage/lcov-report/index.html | grep -A 5 "coverage" || true
        continue-on-error: true
  
  # ======================
  # CREATE RELEASE
  # ======================
  create-release:
    needs: [build-windows-installer, build-linux-packages, build-android-apk, build-vscode-extension, build-web-app, test-with-coverage]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      
      - name: Display artifacts
        run: |
          echo "## Release Artifacts" >> $GITHUB_STEP_SUMMARY
          find release-artifacts -type f -exec ls -lh {} \; >> $GITHUB_STEP_SUMMARY
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-artifacts/windows-installer/*.exe
            release-artifacts/linux-appimage/*.AppImage
            release-artifacts/linux-deb/*.deb
            release-artifacts/android-apk/*.apk
            release-artifacts/vscode-extension/*.vsix
            release-artifacts/web-app/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # ======================
  # BUILD SUMMARY
  # ======================
  build-summary:
    needs: [build-windows-installer, build-linux-packages, build-android-apk, build-vscode-extension, build-web-app, test-with-coverage]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸš€ OpenPilot Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Windows Installer: ${{ needs.build-windows-installer.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Linux Packages: ${{ needs.build-linux-packages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Android APK: ${{ needs.build-android-apk.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- VSCode Extension: ${{ needs.build-vscode-extension.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Web App: ${{ needs.build-web-app.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test-with-coverage.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "All build artifacts are available in the Actions artifacts." >> $GITHUB_STEP_SUMMARY