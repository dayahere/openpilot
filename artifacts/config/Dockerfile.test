# OpenPilot Test Environment Dockerfile
# Provides a complete testing environment with all dependencies

FROM node:20-alpine

# Install Python for auto-fix scripts
RUN apk add --no-cache \
    python3 \
    py3-pip \
    git \
    bash

# Set working directory
WORKDIR /app

# Copy package files first for better caching
COPY package*.json ./
COPY core/package*.json ./core/
COPY tests/package*.json ./tests/

# Install root dependencies
RUN npm install || true

# Install core dependencies
WORKDIR /app/core
RUN npm install

# Install test dependencies
WORKDIR /app/tests
RUN npm install

# Copy all source code
WORKDIR /app
COPY . .

# Install other dependencies (if they exist)
WORKDIR /app/vscode-extension
RUN if [ -f package.json ]; then npm install; fi || true

WORKDIR /app/web
RUN if [ -f package.json ]; then npm install; fi || true

WORKDIR /app/desktop
RUN if [ -f package.json ]; then npm install; fi || true

# Build core library
WORKDIR /app/core
RUN npm run build

# Set working directory back to app root
WORKDIR /app

# Default command: run tests
CMD ["npm", "test", "--prefix", "tests"]
